var CodeSkulptor=CodeSkulptor||{};CodeSkulptor.CSView=function(e,t){var r=function(){this.folder=CodeSkulptor.newFoldFunction(CodeSkulptor.pythonRangeFinder);var t=function(e){var t=e.getCursor(true);var r=e.getCursor(false);var o=t.line;var i=r.line;if(r.ch===0){i-=1}else{r.ch+=1}e.operation(function(){for(var n=o;n<=i;n++){var a=e.getLine(n);e.replaceRange("#"+a,{line:n,ch:0},{line:n})}e.setSelection(t,r)})};var r=function(e){var t=e.getCursor(true);var r=e.getCursor(false);var o=t.line;var i=r.line;if(r.ch===0){i-=1}var n=/^(\s*)\#/;e.operation(function(){var a,s;for(var u=o;u<=i;u++){a=e.getLine(u);s=a.replace(n,"$1");if(a!==s){e.replaceRange(s,{line:u,ch:0},{line:u})}}if(a!==s&&r.ch!==0){r.ch-=1}e.setSelection(t,r)})};this.tabStop=4;this.editor=CodeMirror.fromTextArea(e("#code")[0],{mode:{name:"python",version:2,singleLineStringErrors:false},gutters:["fold-gutter"],fixedGutter:false,lineNumbers:true,indentUnit:this.tabStop,tabMode:"indent",matchBrackets:true,extraKeys:{"Ctrl-Q":function(e){n.folder(e,e.getCursor().line)},"Ctrl-K":t,"Shift-Ctrl-K":r}});this.editor.on("gutterClick",this.folder);this.errorLine=null;this.pre=null;var o={console:"#console",splitBar:"#splitbar",grip:"#grip",runButton:"#run",saveButton:"#save",dlButton:"#dl",freshButton:"#fresh",loadLocalButton:"#loadlocal",resetButton:"#reset",docButton:"#docs",demoButton:"#demos",tipsButton:"#tips",localFile:"#localfile",dlanchor:"#dlhref",topbar:"#controls",brand:"#brand"};for(var i in o){this[i]=e(o[i])}var n=this;CodeMirror.commands.save=function(e){n.saveButton.click()};this.minheight=this.console.height();var a=this.console.offset().top;var s=e("#bottom").height()*3;this.extraheight=a+s;this.split=true;this.edwidth=e(this.editor.getWrapperElement()).width();this.conwidth=this.console.width();this.width=this.edwidth+this.conwidth};var o=function(e,t){if(e[t]){return e[t]()}if(document.createEvent){var r=document.createEvent("HTMLEvents");r.initEvent(t,true,true);return!e.dispatchEvent(r)}else{var r=document.createEventObject();return e.fireEvent("on"+t,r)}};r.prototype.configure=function(e){this.model=e;this.runButton.button({text:false,icons:{primary:"ui-icon-play"}});this.saveButton.button({text:false,icons:{primary:"ui-icon-disk"}});this.dlButton.button({text:false,disabled:true,icons:{primary:"ui-icon-arrowthickstop-1-s"}});this.freshButton.button({text:false,icons:{primary:"ui-icon-suitcase"}});this.loadLocalButton.button({text:false,icons:{primary:"ui-icon-folder-open"}});this.resetButton.button({text:false,icons:{primary:"ui-icon-arrowreturnthick-1-w"}});this.docButton.button({icons:{primary:"ui-icon-info"}});this.demoButton.button({icons:{primary:"ui-icon-script"}});this.tipsButton.button({icons:{primary:"ui-icon-wrench"}})};var i=function(e,t){var r=e.width-t;e.editor.setSize(t,null);r=r|0;e.console.width(r);e.editor.refresh()};var n=function(e,t){t=t-e.extraheight;if(t<e.minheight){t=e.minheight}e.editor.setSize(null,t);e.splitBar.height(t);e.grip[0].style.top=t/2-e.grip.height()/2+"px";e.console.height(t);e.editor.refresh()};var a=function(e,t){var r=t.parentNode;while(r!==null){if(r===e){return true}r=r.parentNode}return false};r.prototype.start=function(){var r=this.model;var s=this;var u=document.getElementById("active");var l=function(e,t){var r=e/2-t/2;s.brand.css({left:r+"px"})};this.brand.load(function(){var e=s.topbar.outerWidth();var t=s.brand.width();l(e,t)});l(this.topbar.outerWidth(),129);this.runButton.click(function(){s.runButton.blur();r.run()});this.saveButton.click(function(){s.saveButton.blur();r.save()});this.freshButton.click(function(){s.freshButton.blur();r.save(true)});this.dlButton.click(function(){var t=s.dlanchor[0];s.dlButton.blur();var r=t.href;var i=e.ajax({url:r,type:"GET",success:function(){o(t,"click")},error:function(){o(t,"click")}})});var c=function(e){var r=u;var o=0;var i=0;while(r&&r.tagName!="BODY"){o+=r.offsetTop;i+=r.offsetLeft;r=r.offsetParent}return{x:e.clientX-i+t.pageXOffset,y:e.clientY-o+t.pageYOffset}};var d=function(e){var t=c(e);var r=t.x>=s.width?s.width:t.x;i(s,r);s.edwidth=r;s.conwidth=s.width-s.edwidth;s.split=true};var h=function(e){u.removeEventListener("mousemove",d,true);u.removeEventListener("mouseup",h,true);u.removeEventListener("mouseout",f,true)};var f=function(e){var t=e.toElement;if(t!==u&&!a(u,t)){u.removeEventListener("mousemove",d,true);u.removeEventListener("mouseup",h,true);u.removeEventListener("mouseout",f,true)}};this.splitBar.hover(function(){e(this).css("cursor","col-resize")},function(){e(this).css("cursor","auto")});this.splitBar.mousedown(function(){document.body.focus();u.addEventListener("mousemove",d,true);u.addEventListener("mouseup",h,true);u.addEventListener("mouseout",f,true);return false});this.splitBar.dblclick(function(){if(s.split){i(s,s.width);s.split=false}else{i(s,s.edwidth);s.split=true}});t.onresize=function(r){var o=e(t).height();n(s,o)};n(s,e(t).height());var p=function(e){var t=e.target.files[0];r.loadLocal(t)};this.localFile.on("change",p);e(document).on("change","#localfile",p);this.loadLocalButton.click(function(){s.loadLocalButton.blur();if(navigator.userAgent.indexOf("Firefox")!=-1){s.localFile.click()}});this.resetButton.click(function(){s.resetButton.blur();r.reset()});this.docButton.click(function(){s.docButton.blur();var e=document.getElementById("docanchor");o(e,"click")});this.demoButton.click(function(){s.demoButton.blur();var e=document.getElementById("demoanchor");o(e,"click")});this.tipsButton.click(function(){s.tipsButton.blur();var e=document.getElementById("tipanchor");o(e,"click")});e(t).bind("hashchange",function(){r.loadRemote(t.location.hash)});this.model.loadRemote(t.location.hash)};r.prototype.setFilename=function(e){t.location.hash=e};r.prototype.showDownload=function(e,t){var r=this;var o=function(e,t){r.dlButton.button("option","disabled",true);r.saveButton.button("option","disabled",false);r.editor.off("change",o);r.saveButton.blur();r.saveButton.removeClass("ui-state-hover")};this.dlanchor.attr("href",e);this.dlButton.button("option","disabled",false);this.saveButton.button("option","disabled",true);this.editor.on("change",o)};r.prototype.getEditState=function(){var e=this.editor.getScrollInfo();var t=this.editor.getCursor();var r=[];var o=false;for(var i=0,n=this.editor.lineCount();i<n;++i){var a=this.editor.findMarksAt({line:i,ch:0});var s=false;for(var u=0;u<a.length;++u){if(a[u].__isFold){s=true;if(!o){r.push(i-1);o=true}}}if(o&&!s){o=false}}var l={x:e.left,y:e.top,cursor:t,folded:r};return l};r.prototype.setCode=function(e,t){var r=this.editor;var o=this.folder;r.setValue(e);if(t){r.setCursor(t.cursor);r.scrollTo(t.x,t.y);for(var i=0;i<t.folded.length;i++){o(r,t.folded[i])}}};r.prototype.getCode=function(){return this.editor.getValue()};r.prototype.getTabStop=function(){return this.tabStop};r.prototype.setHash=function(e){t.location.hash=e};r.prototype.consoleOutput=function(t){if(!this.pre){this.pre=e("<pre />");this.console.append(this.pre)}var r=e("<div />").text(t).html();this.pre.append(r);this.console.scrollTop(this.console.prop("scrollHeight"))};r.prototype.colorOutput=function(t,r){var o=e("<pre />");var i=e("<span />");i.css("color",r);var n=e("<div />").text(t).html();i.append(n);o.append(i);this.console.append(o);this.console.scrollTop(this.console.prop("scrollHeight"));this.pre=null};r.prototype.exceptOutput=function(e,t,r){var o="";var i=r();var n=t();if(i){o+="File '"+i+"', "}if(n){o+="Line "+n+": "}o+=e;this.colorOutput(o,"red");if(n&&i===undefined){this.errorLine=this.editor.addLineClass(n-1,"background","activeline");this.editor.setCursor(n-1);this.editor.focus()}};r.prototype.reset=function(){if(this.errorLine){this.editor.removeLineClass(this.errorLine,"background","activeline");this.errorLine=null}this.console.html("");this.pre=null;if(CodeMirror.commands.clearSearch!==undefined){CodeMirror.commands.clearSearch(this.editor)}};return r}(jQuery,window);var CodeSkulptor=CodeSkulptor||{};CodeSkulptor.pythonRangeFinder=function(e,t){var r=e.getOption("tabSize");var o=e.getLine(t.line);var i=CodeMirror.countColumn(o,null,r);var n=null;for(var a=t.line+1,s=e.lineCount();a<s;++a){var u=e.getLine(a);if(!/^\s*(?:\#.*)?$/.test(u)){if(CodeMirror.countColumn(u,null,r)<=i){break}n=a}}if(!n){return null}return{from:{line:t.line,ch:o.length},to:{line:n,ch:e.getLine(n).length}}};CodeSkulptor.newFoldFunction=function(e,t){if(t==null)t="↔";if(typeof t=="string"){var r=document.createTextNode(t);t=document.createElement("span");t.appendChild(r);t.className="CodeMirror-foldmarker"}return function(r,o){if(typeof o=="number")o={line:o,ch:0};var i=e(r,o);if(!i)return;var n=r.findMarksAt(i.from),a=0;for(var s=0;s<n.length;++s){if(n[s].__isFold){++a;n[s].clear()}}if(a){r.setGutterMarker(o.line,"fold-gutter",null);return}var u=t.cloneNode(true);var l=r.markText(i.from,i.to,{replacedWith:u,clearOnEnter:true,__isFold:true});CodeMirror.on(u,"mousedown",function(){l.clear()});CodeMirror.on(l,"clear",function(){r.setGutterMarker(o.line,"fold-gutter",null)});var c=document.createElement("span");c.appendChild(document.createTextNode("▶"));c.style.color="#600";r.setGutterMarker(o.line,"fold-gutter",c)}};var CodeSkulptor=CodeSkulptor||{};CodeSkulptor.GoogleData={baseURL:"http://codeskulptor-{0}.commondatastorage.googleapis.com/",writeBucket:"user43",googleid:"GOOG6SZXNMC2GUMPY4FG",policy:"eyJleHBpcmF0aW9uIjogIjIwMTgtMDEtMDFUMTI6MDA6MDAuMDAwWiIsCgogICJjb25kaXRpb25zIjogWwogICAgeyJidWNrZXQiOiAiY29kZXNrdWxwdG9yLXVzZXI0MyJ9LAogICAgWyJzdGFydHMtd2l0aCIsICIka2V5IiwgInVzZXI0MyJdLAogICAgWyJlcSIsICIkQ29udGVudC1UeXBlIiwgInRleHQveC1weXRob24iXSwKICAgIFsiY29udGVudC1sZW5ndGgtcmFuZ2UiLCAwLCA2NTUzNl0KICBdCn0K",signature:"3J51uGp8sOizZ23Abc/26HErVRQ="};var CodeSkulptor=CodeSkulptor||{};String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,r){return typeof e[r]!="undefined"?e[r]:t})};CodeSkulptor.CSModel=function(e){var t=function(e,t,r){this.bucket=undefined;this.uid=undefined;this.seqnum=undefined;this.ext=undefined;this.filename=undefined;this.hashLen=e;this.shareLen=1.5*e|0;this.baseURL=t;this.writeBucket=r};var r=".py";var o=4;t.prototype.configure=function(e){this.view=e};var i=""+"# CodeSkulptor runs Python programs in your browser.\n"+"# Click the upper left button to run this simple demo.\n"+"\n"+"# CodeSkulptor runs in Chrome 18+, Firefox 11+, and Safari 6+.\n"+"# Some features may work in other browsers, but do not expect\n"+"# full functionality.  It does NOT run in Internet Explorer.\n"+"\n"+"import simplegui\n"+"\n"+'message = "Welcome!"\n'+"\n"+"# Handler for mouse click\n"+"def click():\n"+"    global message\n"+'    message = "Good job!"\n'+"\n"+"# Handler to draw on canvas\n"+"def draw(canvas):\n"+'    canvas.draw_text(message, [50,112], 48, "Red")\n'+"\n"+"# Create a frame and assign callbacks to event handlers\n"+'frame = simplegui.create_frame("Home", 300, 200)\n'+'frame.add_button("Click me", click)\n'+"frame.set_draw_handler(draw)\n"+"\n"+"# Start the frame animation\n"+"frame.start()\n";t.prototype.spaceRE=/^ *\t[ \t]*/gm;t.prototype.spacesForTabs=function(e){return function(t){var r="";var o;var i;for(o=0;o<t.length;o++){if(t.charAt(o)==="\t"){i=e-r.length%e;r+=Array(i+1).join(" ")}else{r+=" "}}return r}};t.prototype.start=function(){var t=this;var r=function(e){var t=/^\.\/([a-zA-Z][a-zA-Z0-9]*)\_([\w]+?)(?:\_(\d+))?\.py$/;var r=e.match(t);var o,i,n;var a;if(r==null){return null}o=r[1];i=r[2];if(r[3]===undefined){n=null}else{n=parseInt(r[3])}a=o+"_"+i;if(n!=null){a+="_"+n}a+=".py";console.log("Import: bucket: "+o+" uid: "+i+" seqnum: "+n+" filename: "+a);return{bucket:o,filename:a}};var o=function(o){if(Sk.builtinFiles!==undefined){if(Sk.builtinFiles["files"][o]!==undefined){return Sk.builtinFiles["files"][o]}}var i=r(o);if(i!==null){var n=t.baseURL.format(i.bucket)+i.filename;var a={async:false,error:function(e,t,r){throw"File not found: '"+o+"'"},timeout:5e3};var s=e.ajax(n,a).responseText;var u=t.view.getTabStop();s=s.replace(t.spaceRE,t.spacesForTabs(u));Sk.execStart=new Date;return s}throw"File not found: '"+o+"'"};var n=function(e){t.handle_exception(e)};Sk.configure({output:this.view.stdout,debugout:this.view.stddbg,read:o,error:n});this.view.setCode(i)};t.prototype.handle_exception=function(e){if(e instanceof Sk.builtin.ParseError||e instanceof Sk.builtin.SyntaxError||e instanceof Sk.builtin.IndentationError||e instanceof Sk.builtin.TokenError){try{if(e.args.v[2]!==undefined){Sk.currLineNo=e.args.v[2]}if(e.args.v[1]!==undefined){Sk.currFilename=e.args.v[1].v}var t=e.args.v[3][0][1];var r=e.args.v[3][1][1];var o=e.args.v[3][2].substring(t,r);e.args.v[0]=e.args.v[0].sq$concat(new Sk.builtin.str(" ('"+o+"')"))}catch(e){}}var i=e.tp$name+": "+e;this.view.stderr(i);this.sk_cleanup()};var n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";t.prototype.createHash=function(e){var t="";var r;var o=e||this.hashLen;for(r=0;r<o;r++){t+=n.charAt(Math.random()*n.length|0)}return t};t.prototype.getLineNo=function(){if(Sk.currLineNo){return Sk.currLineNo}return undefined};t.prototype.getFilename=function(){if(Sk.currFilename&&Sk.currFilename!=="<stdin>.py"){var e=Sk.currFilename.split("/");return e[e.length-1]}return undefined};t.prototype.sk_cleanup=function(){if(Sk.simplegui){Sk.simplegui.cleanup();Sk.simplegui=undefined}if(Sk.simpleplot){Sk.simpleplot.cleanup();Sk.simpleplot=undefined}if(Sk.maps){Sk.maps.cleanup();Sk.maps=undefined}};t.prototype.reset=function(){this.sk_cleanup();this.view.reset()};t.prototype.run=function(){var e=this.view.getTabStop();try{var t=this.view.getCode();var r=this.view.getEditState();t=t.replace(this.spaceRE,this.spacesForTabs(e));this.view.setCode(t,r);this.reset();Sk.currLineNo=undefined;Sk.currColNo=undefined;Sk.currFilename=undefined;Sk.setExecLimit(5e3);var o=Sk.importMainWithBody("<stdin>",false,t)}catch(e){this.handle_exception(e)}};var a=function(e,t,o,i){var n=e+"_"+t;if(o>=0){n+="_"+o.toString()}if(i===undefined){n+=r}else{n+=i}return n};var s=function(t,i,n,u){var l;u=u||1;if(u>o){alert("Unable to save at this time.");return}l=a(t.writeBucket,i,n);console.log("Save key: "+l+" attempt: "+u);var c=t.baseURL.format(t.writeBucket)+l;var d=e.ajax({url:c,type:"HEAD",success:function(e,r){i=t.createHash();if(n>=0){n=0}s(t,i,n,u++)},error:function(o,a,s){if(s=="Not Found"){e("#keyid")[0].value=l;e("#codeform")[0].submit();t.bucket=t.writeBucket;t.uid=i;t.seqnum=n;t.ext=r;t.filename=l;t.view.setHash(l);t.view.showDownload(c,l)}else{alert("Unable to save at this time.")}}})};t.prototype.save=function(e){var t;var r;if(e){t=this.createHash(this.shareLen);r=-1}else if(this.uid){t=this.uid;r=this.seqnum+1}else{t=this.createHash();r=0}var o=this.view.getTabStop();var i=this.view.getCode();var n=this.view.getEditState();i=i.replace(this.spaceRE,this.spacesForTabs(o));this.view.setCode(i,n);s(this,t,r)};var u=function(e){if(e.uid){e.view.setHash(e.filename)}else{e.view.setHash("")}};var l=function(e){var t=/^#([a-zA-Z][a-zA-Z0-9]*)[\-_]([\w\-]+?)(?:[\-_](\d+))?(\.py)$/;var r=e.match(t);var o,i,n,a;if(r==null){return null}o=r[1];i=r[2];if(r[3]===undefined){n=-1}else{n=parseInt(r[3])}a=r[4];console.log("New: bucket: "+o+" uid: "+i+" seqnum: "+n+" ext: "+a);return{bucket:o,uid:i,seqnum:n,ext:a}};t.prototype.loadRemote=function(t){if(!t){this.bucket=undefined;this.uid=undefined;this.seqnum=undefined;this.ext=undefined;this.filename=undefined;return}var r=l(t);var o=t.slice(1);if(!r){alert("Invalid file name: "+o);u(this);return}if(this.filename==o){return}var i=this;var n=i.baseURL.format(r.bucket)+o;var a=e.get(n);a.success(function(e,t){i.view.setCode(e);i.reset();i.bucket=r.bucket;i.uid=r.uid;i.seqnum=r.seqnum;i.ext=r.ext;i.filename=o});a.error(function(e,t,r){u(i);alert("Unable to load file: "+o)})};var c=function(e){var t="";switch(e.currentTarget.error.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA EXCEEDED";break;case FileError.NOT_FOUND_ERR:t="NOT FOUND";break;case FileError.SECURITY_ERR:t="SECURITY ERROR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID MODIFICATION";break;case FileError.INVALID_STATE_ERR:t="INVALID STATE";break;default:t="Unknown Error";break}alert("Error opening file: "+t)};t.prototype.loadLocal=function(e){var t=this;var r=new FileReader;r.onload=function(e){t.view.setCode(e.target.result)};r.onerror=c;r.readAsText(e)};return t}(jQuery);var CodeSkulptor=CodeSkulptor||{};CodeSkulptor.Controller=function(){this.view=new CodeSkulptor.CSView;this.model=new CodeSkulptor.CSModel(10,CodeSkulptor.GoogleData.baseURL,CodeSkulptor.GoogleData.writeBucket);var e=CodeSkulptor.GoogleData.baseURL.format(CodeSkulptor.GoogleData.writeBucket);$("#codeform")[0].action=e;$("#googleid")[0].value=CodeSkulptor.GoogleData.googleid;$("#policy")[0].value=CodeSkulptor.GoogleData.policy;$("#signature")[0].value=CodeSkulptor.GoogleData.signature;var t=function(e,t){return function(){return e.apply(t,arguments)}};var r={stdout:t(this.view.consoleOutput,this.view),stddbg:t(function(e){this.view.colorOutput(e,"blue")},this),stderr:t(function(e){this.view.exceptOutput(e,this.model.getLineNo,this.model.getFilename)},this),setFilename:t(this.view.setFilename,this.view),showDownload:t(this.view.showDownload,this.view),getEditState:t(this.view.getEditState,this.view),setCode:t(this.view.setCode,this.view),getCode:t(this.view.getCode,this.view),getTabStop:t(this.view.getTabStop,this.view),setHash:t(this.view.setHash,this.view),reset:t(this.view.reset,this.view)};var o={run:t(this.model.run,this.model),save:t(this.model.save,this.model),loadRemote:t(this.model.loadRemote,this.model),loadLocal:t(this.model.loadLocal,this.model),reset:t(this.model.reset,this.model)};this.view.configure(o);this.model.configure(r);this.model.start();this.view.start()};jQuery(function(e){var t=new CodeSkulptor.Controller});